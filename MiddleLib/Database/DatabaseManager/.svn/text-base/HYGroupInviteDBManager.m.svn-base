//
//  HYGroupInviteDBManager.m
//  iRCS
//
//  Created by 王斌 on 15/8/31.
//  Copyright (c) 2015年 frank weng. All rights reserved.
//

#import "HYGroupInviteDBManager.h"

@interface HYGroupInviteDBManager()
@property (nonatomic, strong) HYDatabaseHelper *dbHelper;
@end

@implementation HYGroupInviteDBManager

SINGLETON_GENERATOR(HYGroupInviteDBManager, defaultManager)

- (id)init
{
    self = [super init];
    return self;
}

- (void)setup
{
    self.dbHelper = [HYDatabaseHelper defaultHelper];
    self.database = self.dbHelper.database;
    self.databaseQueue = self.dbHelper.databaseQueue;
}

#pragma mark 增
- (BOOL)createTable
{
    NSDictionary *param = @{@"groupID": @"text",
                                            @"groupName": @"text",
                                            @"groupSubject": @"text",
                                            @"groupDescription": @"text",
                                            @"inviterID": @"text",
                                            @"inviterNickName":@"text",
                                            @"joinStatus": @"integer",
                                            @"timeStamp": @"integer",
                                            @"isRead": @"bool"};

    return [self.dbHelper creatTableWithTable:GROUPINVITE_TABLE Param:param];
}

- (BOOL)addGroupInviteInDBWithModel:(GroupInviteModel *)groupInviteModel
{
    __block BOOL rst = NO;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        if (groupInviteModel) {
            NSString *sql = [NSString stringWithFormat:@"insert into %@ (groupID,groupName,groupSubject,groupDescription,inviterID,inviterNickName,joinStatus,timeStamp,isRead) values('%@','%@','%@','%@','%@','%@','%u','%ld','%d')",GROUPINVITE_TABLE,groupInviteModel.groupID,groupInviteModel.groupName,groupInviteModel.groupSubject,groupInviteModel.groupDescription,groupInviteModel.inviterID,groupInviteModel.inviterNickName,groupInviteModel.joinStatus,(long)groupInviteModel.timeStamp,groupInviteModel.isRead];
            rst = [db executeUpdate:sql];
        }
        
    }];
    return rst;
}

#pragma mark 删
- (BOOL)deleteGroupInviteInDBWithGroupID:(NSString *)groupID InviterID:(NSString *)inviterID
{
    __block BOOL rst = NO;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        if (groupID) {
            NSString *sql = [NSString stringWithFormat:@"delete from %@ where groupID = '%@' AND inviterID = '%@'",GROUPINVITE_TABLE,groupID,inviterID];
            rst = [db executeUpdate:sql];
        }
        
    }];
    return rst;
}

#pragma mark 改
-(BOOL)updateGroupInviteJoinStatusWithGroupID:(NSString *)groupID InviterID:(NSString *)inviterID IsJoin:(int)joinStatus{
    __block BOOL rst = NO;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        if (groupID) {
            NSString *sql = [NSString stringWithFormat:@"UPDATE %@ SET joinStatus = '%d' where groupID = '%@' and inviterID = '%@'",GROUPINVITE_TABLE,joinStatus,groupID,inviterID];
            rst = [db executeUpdate:sql];
        }
        
    }];
    return rst;
}

-(BOOL)updateGroupInviteJoinStatusWithGroupID:(NSString *)groupID InviterID:(NSString *)inviterID TimeStamp:(int)timeStamp{
    __block BOOL rst = NO;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        if (groupID) {
            NSString *sql = [NSString stringWithFormat:@"UPDATE %@ SET timeStamp = '%d', joinStatus = '0', isRead = '0' where groupID = '%@' and inviterID = '%@'",GROUPINVITE_TABLE,timeStamp,groupID,inviterID];
            rst = [db executeUpdate:sql];
        }
        
    }];
    return rst;
}

-(BOOL) setAllGroupInviteIsRead{
    __block BOOL rst = NO;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {

        NSString *sql = [NSString stringWithFormat:@"UPDATE %@ SET isRead = '1' where isRead = '0'",GROUPINVITE_TABLE];
        rst = [db executeUpdate:sql];
        
    }];
    return rst;
}



#pragma mark 查
-(NSArray *)getGroupInviteInDB{
    __block NSMutableArray   *groupInviteMutableArray = [NSMutableArray array];
    __block GroupInviteModel *groupInvite = nil;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        NSString *sql = [NSString stringWithFormat:@"SELECT * FROM %@ ORDER BY timeStamp DESC",GROUPINVITE_TABLE];
        HYFMResultSet * rs = [db executeQuery:sql];
        while([rs next]) {
            groupInvite                  = [[GroupInviteModel alloc] init];
            groupInvite.groupID          = [rs stringForColumn:@"groupID"];
            groupInvite.groupName        = [rs stringForColumn:@"groupName"];
            groupInvite.groupSubject     = [rs stringForColumn:@"groupSubject"];
            groupInvite.groupDescription = [rs stringForColumn:@"groupDescription"];
            groupInvite.inviterID        = [rs stringForColumn:@"inviterID"];
            groupInvite.inviterNickName  = [rs stringForColumn:@"inviterNickName"];
            groupInvite.joinStatus       = [rs boolForColumn:@"joinStatus"];
            groupInvite.timeStamp        = [rs intForColumn:@"timeStamp"];
            groupInvite.isRead           = [rs boolForColumn:@"isRead"];
            if (![groupInvite.groupID isValidString] || [groupInvite.groupID isEqualToString:@"(null)"]) {
                groupInvite.groupID = nil;
            }
            if (![groupInvite.groupName isValidString] || [groupInvite.groupName isEqualToString:@"(null)"]) {
                groupInvite.groupName = nil;
            }
            if (![groupInvite.groupSubject isValidString] || [groupInvite.groupSubject isEqualToString:@"(null)"]) {
                groupInvite.groupSubject = nil;
            }
            if (![groupInvite.groupDescription isValidString] || [groupInvite.groupDescription isEqualToString:@"(null)"]) {
                groupInvite.groupDescription = nil;
            }
            if (![groupInvite.inviterID isValidString] || [groupInvite.inviterID isEqualToString:@"(null)"]) {
                groupInvite.inviterID = nil;
            }
            if (![groupInvite.inviterNickName isValidString] || [groupInvite.inviterNickName isEqualToString:@"(null)"]) {
                groupInvite.inviterNickName = nil;
            }
            
            [groupInviteMutableArray safeAddObject:groupInvite];

        }
        [rs close];
    }];
    return groupInviteMutableArray;
}

-(NSArray *)getGroupInviteInDBWithRange:(NSRange)range{
    __block NSMutableArray   *groupInviteMutableArray = [NSMutableArray array];
    __block GroupInviteModel *groupInvite = nil;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        NSString *sql = [NSString stringWithFormat:@"SELECT * FROM %@ ORDER BY timeStamp DESC LIMIT '%lu' OFFSET '%lu'",GROUPINVITE_TABLE, range.length, range.location];
        HYFMResultSet * rs = [db executeQuery:sql];
        while([rs next]) {
            groupInvite                  = [[GroupInviteModel alloc] init];
            groupInvite.groupID          = [rs stringForColumn:@"groupID"];
            groupInvite.groupName        = [rs stringForColumn:@"groupName"];
            groupInvite.groupSubject     = [rs stringForColumn:@"groupSubject"];
            groupInvite.groupDescription = [rs stringForColumn:@"groupDescription"];
            groupInvite.inviterID        = [rs stringForColumn:@"inviterID"];
            groupInvite.inviterNickName  = [rs stringForColumn:@"inviterNickName"];
            groupInvite.joinStatus       = [rs boolForColumn:@"joinStatus"];
            groupInvite.timeStamp        = [rs intForColumn:@"timeStamp"];
            groupInvite.isRead           = [rs boolForColumn:@"isRead"];
            if (![groupInvite.groupID isValidString] || [groupInvite.groupID isEqualToString:@"(null)"]) {
                groupInvite.groupID = nil;
            }
            if (![groupInvite.groupName isValidString] || [groupInvite.groupName isEqualToString:@"(null)"]) {
                groupInvite.groupName = nil;
            }
            if (![groupInvite.groupSubject isValidString] || [groupInvite.groupSubject isEqualToString:@"(null)"]) {
                groupInvite.groupSubject = nil;
            }
            if (![groupInvite.groupDescription isValidString] || [groupInvite.groupDescription isEqualToString:@"(null)"]) {
                groupInvite.groupDescription = nil;
            }
            if (![groupInvite.inviterID isValidString] || [groupInvite.inviterID isEqualToString:@"(null)"]) {
                groupInvite.inviterID = nil;
            }
            if (![groupInvite.inviterNickName isValidString] || [groupInvite.inviterNickName isEqualToString:@"(null)"]) {
                groupInvite.inviterNickName = nil;
            }
            
            [groupInviteMutableArray safeAddObject:groupInvite];
            
        }
        [rs close];
    }];
    return groupInviteMutableArray;
}

-(GroupInviteModel *) getTopGroupInviteInDB{
    __block GroupInviteModel *groupInvite = nil;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        NSString *sql = [NSString stringWithFormat:@"SELECT * FROM %@ WHERE joinStatus = '0' ORDER BY timeStamp DESC Limit 1",GROUPINVITE_TABLE];
        HYFMResultSet * rs = [db executeQuery:sql];
        if([rs next]) {
            groupInvite                  = [[GroupInviteModel alloc] init];
            groupInvite.groupID          = [rs stringForColumn:@"groupID"];
            groupInvite.groupName        = [rs stringForColumn:@"groupName"];
            groupInvite.groupSubject     = [rs stringForColumn:@"groupSubject"];
            groupInvite.groupDescription = [rs stringForColumn:@"groupDescription"];
            groupInvite.inviterID        = [rs stringForColumn:@"inviterID"];
            groupInvite.inviterNickName  = [rs stringForColumn:@"inviterNickName"];
            groupInvite.joinStatus       = [rs intForColumn:@"joinStatus"];
            groupInvite.timeStamp        = [rs intForColumn:@"timeStamp"];
            groupInvite.isRead           = [rs boolForColumn:@"isRead"];
            if (![groupInvite.groupID isValidString] || [groupInvite.groupID isEqualToString:@"(null)"]) {
                groupInvite.groupID = nil;
            }
            if (![groupInvite.groupName isValidString] || [groupInvite.groupName isEqualToString:@"(null)"]) {
                groupInvite.groupName = nil;
            }
            if (![groupInvite.groupSubject isValidString] || [groupInvite.groupSubject isEqualToString:@"(null)"]) {
                groupInvite.groupSubject = nil;
            }
            if (![groupInvite.groupDescription isValidString] || [groupInvite.groupDescription isEqualToString:@"(null)"]) {
                groupInvite.groupDescription = nil;
            }
            if (![groupInvite.inviterID isValidString] || [groupInvite.inviterID isEqualToString:@"(null)"]) {
                groupInvite.inviterID = nil;
            }
            if (![groupInvite.inviterNickName isValidString] || [groupInvite.inviterNickName isEqualToString:@"(null)"]) {
                groupInvite.inviterNickName = nil;
            }
        }
        [rs close];
    }];
    return groupInvite;
}

- (int) getUnReadCount{
    __block int count = 0;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        NSString *sql = [NSString stringWithFormat:@"SELECT * FROM %@ WHERE isRead = '0' ",GROUPINVITE_TABLE];
        HYFMResultSet * rs = [db executeQuery:sql];
        while ([rs next]) {
            count++;
        }
        [rs close];
    }];
    return count;
}

- (BOOL) isExistGroupInviteWithGroupID:(NSString *)groupID InviteID:(NSString *)inviterID{
    __block BOOL rst = NO;
    [self.databaseQueue inDatabase:^(HYFMDatabase *db) {
        if (groupID) {
            NSString *sql = [NSString stringWithFormat:@"SELECT * FROM %@ WHERE groupID = '%@' AND inviterID = '%@'",GROUPINVITE_TABLE,groupID,inviterID];
            HYFMResultSet * rs = [db executeQuery:sql];
            if ([rs next]) {
                rst = YES;
            }
        }
        
    }];
    return rst;
}

@end
